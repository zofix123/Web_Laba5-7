<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<div style="text-align: right; color: gray; font-size: 0.9em;">
  Текущее время сервера: <span th:text="${serverTime}"></span>
</div>

<h2>Смена пароля</h2>

<div th:if="${session.user == null}">
  <p>Вы не авторизованы</p>
  <a th:href="@{/users/login}">Войти</a>
</div>

<div th:if="${session.user != null}">
  <p th:if="${error}" th:text="${error}" style="color:red"></p>
  <p th:if="${success}" th:text="${success}" style="color:green"></p>

  <form th:action="@{/users/change-password}" method="post" onsubmit="return validatePassword()">
    <input type="hidden" name="userId" th:value="${session.user.id}">

    <label>Старый пароль:</label><br>
    <input type="password" name="oldPassword" required><br><br>

    <label>Новый пароль (мин. 4 символа):</label><br>
    <input type="password" id="newPassword" name="newPassword"
           placeholder="Минимум 4 символа" required
           minlength="4" oninput="checkPasswordStrength()"><br>
    <div id="password-strength" style="font-size: 0.8em; margin-bottom: 5px;"></div>

    <label>Подтвердите новый пароль:</label><br>
    <input type="password" id="confirmNewPassword" name="confirmNewPassword"
           placeholder="Повторите новый пароль" required
           minlength="4"><br>
    <div id="password-match" style="font-size: 0.8em; margin-bottom: 10px;"></div>

    <button type="submit">Сменить пароль</button>
  </form>

  <script>
    function checkPasswordStrength() {
      const password = document.getElementById('newPassword').value;
      const strengthDiv = document.getElementById('password-strength');

      if (password.length === 0) {
        strengthDiv.innerHTML = '';
        return;
      }

      if (password.length < 4) {
        strengthDiv.innerHTML = 'Слишком короткий пароль (минимум 4 символа)';
        strengthDiv.style.color = 'red';
      } else if (password.length < 6) {
        strengthDiv.innerHTML = 'Слабый пароль';
        strengthDiv.style.color = 'orange';
      } else if (password.length < 8) {
        strengthDiv.innerHTML = 'Средний пароль';
        strengthDiv.style.color = 'blue';
      } else {
        strengthDiv.innerHTML = 'Надежный пароль';
        strengthDiv.style.color = 'green';
      }
    }

    function validatePassword() {
      const password = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      const matchDiv = document.getElementById('password-match');

      if (password.length < 4) {
        matchDiv.innerHTML = 'Пароль должен содержать минимум 4 символа';
        matchDiv.style.color = 'red';
        return false;
      }

      if (password !== confirmPassword) {
        matchDiv.innerHTML = 'Пароли не совпадают';
        matchDiv.style.color = 'red';
        return false;
      } else {
        matchDiv.innerHTML = 'Пароли совпадают ✓';
        matchDiv.style.color = 'green';
      }

      return true;
    }

    document.getElementById('confirmNewPassword').addEventListener('input', function() {
      const password = document.getElementById('newPassword').value;
      const confirmPassword = this.value;
      const matchDiv = document.getElementById('password-match');

      if (confirmPassword.length === 0) {
        matchDiv.innerHTML = '';
        return;
      }

      if (password !== confirmPassword) {
        matchDiv.innerHTML = 'Пароли не совпадают';
        matchDiv.style.color = 'red';
      } else {
        matchDiv.innerHTML = 'Пароли совпадают ✓';
        matchDiv.style.color = 'green';
      }
    });
  </script>

  <br><br>
  <a th:href="@{/profile}">Вернуться в профиль</a>
</div>

</body>
</html>