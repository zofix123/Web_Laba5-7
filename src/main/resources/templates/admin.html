<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Сайт знакомств - панель администратора</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
<div class="page">
  <header class="header">
    <div class="header__inner">
      <div></div>

      <div class="header__brand">
        <a href="/main">САЙТ ЗНАКОМСТВ</a>
      </div>

      <nav class="header__nav">
        <a href="/profile">ПРОФИЛЬ</a>
      </nav>
    </div>
  </header>

  <div class="server-time">
    Текущее время сервера: <span id="serverTime" th:text="${serverTime}">—</span>
  </div>

  <main class="content">
    <section class="box admin">
      <div class="admin__top">
        <a class="link" th:href="@{/profile}">← Назад в профиль</a>
        <div class="admin__title">ПАНЕЛЬ АДМИНИСТРАТОРА</div>
        <div></div>
      </div>

      <div class="admin__stats">
        Всего пользователей: <strong th:text="${totalUsers}">0</strong>
        <span class="admin__sep">|</span>
        Администраторов: <strong th:text="${adminCount}">0</strong>
        <span class="admin__sep">|</span>
        Модераторов: <strong th:text="${moderatorCount}">0</strong>
        <span class="admin__sep">|</span>
        Пользователей: <strong th:text="${userCount}">0</strong>
      </div>

      <div class="admin__msg admin__msg--ok" th:if="${success}" th:text="${success}"></div>
      <div class="admin__msg admin__msg--err" th:if="${error}" th:text="${error}"></div>

      <div th:if="${users != null and !users.isEmpty()}">
        <div class="admin__table-wrap">
          <table class="admin-table">
            <thead>
            <tr>
              <th>ID</th>
              <th>Имя</th>
              <th>Email</th>
              <th>Рожд.</th>
              <th>Возраст</th>
              <th>Роль</th>
              <th>Визиты</th>
              <th>Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="u : ${users}">
              <td th:text="${u.id}">1</td>
              <td th:text="${u.name}">Имя</td>
              <td th:text="${u.email}">mail</td>
              <td th:text="${u.birth}">2000-01-01</td>
              <td th:text="${u.age}">18</td>

              <td>
                <!-- Роль меняем только не себе -->
                <form th:if="${session.user != null and session.user.id != u.id}"
                      th:action="@{/users/admin/update-role/{id}(id=${u.id})}"
                      method="post"
                      class="admin-role">
                  <select name="role" class="admin-role__select" onchange="this.form.submit()">
                    <option value="admin" th:selected="${u.role == 'admin'}">admin</option>
                    <option value="moderator" th:selected="${u.role == 'moderator'}">moderator</option>
                    <option value="user" th:selected="${u.role == 'user'}">user</option>
                  </select>
                </form>

                <span th:if="${session.user != null and session.user.id == u.id}"
                      th:text="${u.role} + ' (вы)'">user (вы)</span>
              </td>

              <td th:text="${u.visitCount}">1</td>

              <td class="admin-actions">
                <button class="button button--small"
                        type="button"
                        th:attr="data-id=${u.id},
                                                 data-name=${u.name},
                                                 data-email=${u.email},
                                                 data-birth=${#temporals.format(u.birth,'yyyy-MM-dd')},
                                                 data-role=${u.role}"
                        onclick="openEditModalFromData(this)">
                  Изменить
                </button>

                <form th:if="${session.user != null and session.user.id != u.id}"
                      th:action="@{/users/admin/delete/{id}(id=${u.id})}"
                      method="post"
                      class="admin-delete"
                      th:attr="data-name=${u.name}"
                      onsubmit="return confirmDelete(this)">
                  <button class="button button--small button--danger" type="submit">Удалить</button>
                </form>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div th:if="${users == null or users.isEmpty()}" class="admin__empty">
        Нет пользователей для отображения.
      </div>
    </section>

    <!-- Модалка -->
    <div id="editModal" class="modal" aria-hidden="true">
      <div class="modal__content">
        <button class="modal__close" type="button" onclick="closeEditModal()" aria-label="Закрыть">×</button>

        <div class="modal__title">Редактирование пользователя</div>

        <form id="editForm" method="post" action="">
          <div class="modal__grid">
            <label class="modal-field">
              <span class="modal-field__label">Имя</span>
              <input class="modal-field__input" type="text" id="editName" name="name">
            </label>

            <label class="modal-field">
              <span class="modal-field__label">Email</span>
              <input class="modal-field__input" type="email" id="editEmail" name="email">
            </label>

            <label class="modal-field">
              <span class="modal-field__label">Дата рождения</span>
              <input class="modal-field__input" type="date" id="editBirth" name="birth">
            </label>

            <label class="modal-field">
              <span class="modal-field__label">Роль</span>
              <select class="modal-field__input" id="editRole" name="role">
                <option value="admin">admin</option>
                <option value="moderator">moderator</option>
                <option value="user">user</option>
              </select>
            </label>
          </div>

          <div class="modal__actions">
            <button class="button button--small" type="button" onclick="closeEditModal()">Отмена</button>
            <button class="button button--small" type="submit">Сохранить</button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <footer class="footer">
    Сайт разработали студенты группы 24ВП1 Гриднев Владислав и Пономарев Павел
  </footer>
</div>

<script th:src="@{/js/time_fetcher.js}"></script>
<script th:src="@{/js/adminFunctions.js}"></script>
</body>
</html>
